{% extends "base.html" %}
{% block title %}환자 상세 정보 – GuGu Medical Center EMR{% endblock %}

{% block content %}
<a href="/dashboard" class="back-button">← 메인 대시보드</a>

<div id="custom-toast" class="toast hidden"></div>
<div class="patient-header">
  <h1 class="patient-title">{{ name }}&nbsp;님 <span>({{ birth_date }})</span></h1>
</div>

<div class="emr-layout">

  <!-- (1) 방문 기록 -->
  <div class="emr-card visits-panel">
    <h2>방문 기록</h2>
    <ul>
      {% for record in visit_records %}
      <li data-visit-date="{{ record.record_date.strftime('%Y-%m-%d') }}">
        <a href="#" class="record-link">{{ record.record_date.strftime('%Y-%m-%d') }}</a>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- (2) 일일기록지 작성 -->
  <div class="emr-card form-panel">
    <h2>일일기록지 작성</h2>
    <div class="btn-chart-container">
      <a class="btn-chart" , href="/patient_emr/new_patient_chart?name={{ name }}&birth_date={{ birth_date }}">
        신환 차트
      </a>
    </div>
    <form id="new-emr-form" action="/patient_emr/new_emr" method="post">
      <input type="hidden" name="name" value="{{ name }}">
      <input type="hidden" name="birth_date" value="{{ birth_date }}">

      <!-- 1. Date -->
      <div class="form-group date-inline">
        <label for="record_date">Date</label>
        <input type="date" id="record_date" name="record_date" required>
      </div>


      <!-- 2. 성명 / 성별 / 나이 -->
      <div class="form-group header-group">
        <label for="display_name">&nbsp;성명</label>
        <input type="text" id="display_name" name="display_name" value="{{ name }}" readonly>

        <label for="gender">&nbsp;&nbsp;성별</label>
        <select id="gender" name="gender">
          <option>남</option>
          <option>여</option>
        </select>

        <label for="age">&nbsp;&nbsp;나이</label>
        <input type="text" id="age" name="age" readonly>
      </div>

      <!-- 3. Vital Signs -->
      <fieldset class="section-fieldset">
        <legend>Vital Signs (V/S)</legend>
        <div class="vitals-grid">
          <div class="vital-item">
            <label for="bt">BT (°C)</label>
            <input type="text" id="bt" name="bt" placeholder="36.5">
          </div>
          <div class="vital-item">
            <label for="bp">BP (mmHg)</label>
            <input type="text" id="bp" name="bp" placeholder="120/80">
          </div>
          <div class="vital-item">
            <label for="hr">HR (bpm)</label>
            <input type="text" id="hr" name="hr" placeholder="72">
          </div>
          <div class="vital-item">
            <label for="bp2">2차 BP</label>
            <input type="text" id="bp2" name="bp2" placeholder="--">
          </div>
          <div class="vital-item">
            <label for="bst">BST</label>
            <input type="text" id="bst" name="bst" placeholder="110">
          </div>
          <div class="vital-item">
            <label for="post_bst">식후(시간)</label>
            <input type="text" id="post_bst" name="post_bst" placeholder="2">
          </div>
        </div>
      </fieldset>

      <!-- 4. C.C. + Onset/Duration/Assoc.Sx -->
      <fieldset class="section-fieldset cc-fieldset">
        <legend>C.C. (주호소)</legend>
        <div class="form-group">
          <textarea id="cc" name="cc" placeholder="환자 주호소를 입력하세요"></textarea>
        </div>
        <div class="form-group inline-group no-wrap">
          <div class="inline-item">
            <label for="onset">Onset</label>
            <input type="text" id="onset" name="onset" placeholder="ex: 2일 전">
          </div>
          <div class="inline-item">
            <label for="duration">Duration</label>
            <input type="text" id="duration" name="duration" placeholder="ex: 1일">
          </div>
          <div class="inline-item">
            <label for="assoc">Assoc. Sx.</label>
            <input type="text" id="assoc" name="assoc" placeholder="관련 증상">
          </div>
        </div>
      </fieldset>

      <!-- 5. History -->
      <fieldset class="section-fieldset">
        <legend>History</legend>
        <div class="form-group">
          <label for="med_hx">Medication Hx.</label>
          <input type="text" id="med_hx" name="medication_hx" placeholder="복용 중인 약물">
        </div>
        <div class="form-group">
          <label for="pmhx">PMHx.</label>
          <input type="text" id="pmhx" name="pmhx" placeholder="과거 병력">
        </div>
        <div class="form-group inline-group no-wrap">
          <div class="inline-item">
            <label for="allergy">Allergy</label>
            <input type="text" id="allergy" name="allergy" placeholder="유/무">
          </div>
          <div class="inline-item">
            <label for="fhx">FHx.</label>
            <input type="text" id="fhx" name="fhx" placeholder="가족력">
          </div>
          <div class="inline-item">
            <label for="social">Social</label>
            <input type="text" id="social" name="social" placeholder="흡연/음주">
          </div>
        </div>
      </fieldset>

      <!-- 6. P.I. -->
      <div class="form-group">
        <label for="pi">P.I. (병력)</label>
        <textarea id="pi" name="pi" rows="3"></textarea>
      </div>

      <!-- 7. ROS -->
      <div class="form-group">
        <label for="ros">ROS</label>
        <input type="text" id="ros" name="ros" placeholder="Review of Systems">
      </div>

      <!-- 8. P/E -->
      <div class="form-group">
        <label for="pe">P/E</label>
        <input type="text" id="pe" name="pe" placeholder="Physical Exam">
      </div>

      <!-- 9. Problem list / Assessment -->
      <div class="form-group">
        <label for="problems">Problem list</label>
        <textarea id="problems" name="problem_list" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label for="assessment">Assessment</label>
        <textarea id="assessment" name="assessment" rows="2"></textarea>
      </div>

      <!-- 10. N/Ex. -->
      <fieldset class="section-fieldset">
        <legend>N/Ex.</legend>
        <table class="ne-table">
          <tr>
            <td><label><input type="checkbox" name="ne_cog"> 인지저하</label></td>
            <td>MMSE <input type="text" name="mmse" style="width:50px;"> /30</td>
            <td>CDR <input type="text" name="cdr" style="width:50px;"></td>
          </tr>
          <tr>
            <td><label><input type="checkbox" name="ne_sleep"> 수면장애</label></td>
            <td colspan="2">
              PSQI <input type="text" name="psqi" style="width:60px;">
              or ISI <input type="text" name="isi" style="width:60px;">
            </td>
          </tr>
          <tr>
            <td><label><input type="checkbox" name="ne_depress"> 우울감</label></td>
            <td colspan="2">GDS <input type="text" name="gds" style="width:60px;"></td>
          </tr>
        </table>
      </fieldset>

      <!-- (4) Prescription — Plan -->
      <fieldset class="form-section">
        <legend>Plan</legend>
        <table class="plan-table">
          <colgroup>
            <col class="col-num">
            <col class="col-desc">
            <col class="col-method">
            <col class="col-period">
          </colgroup>
          <thead>
            <tr>
              <th>#</th>
              <th>Description to P</th>
              <th>Method</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody>
            <!-- (4-1) free input rows #1–4 -->
            {% for i in range(1,5) %}
            <tr>
              <td>{{ i }}</td>
              <td>
                {% if i == 1 %}
                <input type="text" name="plan_desc_{{i}}" placeholder="처방 내용을 입력하세요">
                {% else %}
                <input type="text" name="plan_desc_{{i}}">
                {% endif %}
              </td>
              <td>
                {% if i == 1 %}
                <input type="text" name="plan_method_{{i}}" placeholder="복용 방법">
                {% else %}
                <input type="text" name="plan_method_{{i}}">
                {% endif %}
              </td>
              <td>
                {% if i == 1 %}
                <input type="text" name="plan_period_{{i}}" placeholder="처방 기간">
                {% else %}
                <input type="text" name="plan_period_{{i}}">
                {% endif %}
              </td>
            </tr>
            {% endfor %}

            <!-- (4-2) 파스 -->
            <tr>
              <td>5</td>
              <td>파스</td>
              <td>
                <label><input type="radio" name="plan_pas_5" value="O">O</label>
                <label><input type="radio" name="plan_pas_5" value="X">X</label>
              </td>
              <td>
                <label><input type="radio" name="plan_pas_period_5" value="Cool">Cool</label>
                <label><input type="radio" name="plan_pas_period_5" value="Hot">Hot</label>
              </td>
            </tr>

            <!-- (4-3) 비타민제(삐콤) -->
            <tr>
              <td>6</td>
              <td>삐콤</td>
              <td colspan="2">
                <label><input type="radio" name="plan_bear_6" value="O">O</label>
                <label><input type="radio" name="plan_bear_6" value="X">X</label>
              </td>
            </tr>

            <!-- (4-4) 근육통 -->
            <tr>
              <td>7</td>
              <td>근육통</td>
              <td>
                안티푸라민<br>
                <label><input type="radio" name="plan_anti_7" value="O">O</label>
                <label><input type="radio" name="plan_anti_7" value="X">X</label>
              </td>
              <td>
                루마겔<br>
                <label><input type="radio" name="plan_ruma_7" value="O">O</label>
                <label><input type="radio" name="plan_ruma_7" value="X">X</label>
              </td>
            </tr>

            <!-- (4-5) 발백선: colspan 제거, 빈 셀로 메서드 칸 채움 -->
            <tr>
              <td>8</td>
              <td class="site-row">
                &nbsp;발백선 (site:
                <input type="text" name="plan_tinea_site_8" placeholder="부위">
                )
              </td>
              <td></td> <!-- Method 칸 빈 셀 -->
              <td>
                <label><input type="radio" name="plan_tinea_8" value="O">O</label>
                <label><input type="radio" name="plan_tinea_8" value="X">X</label>
              </td>
            </tr>

            <!-- (4-6) 피부염: 동일하게 -->
            <tr>
              <td>9</td>
              <td class="site-row">
                &nbsp;피부염 (site:
                <input type="text" name="plan_derma_site_9" placeholder="부위">
                )
              </td>
              <td></td>
              <td>
                <label><input type="radio" name="plan_derma_9" value="O">O</label>
                <label><input type="radio" name="plan_derma_9" value="X">X</label>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <!-- (5) Medication Counseling -->
      <fieldset class="form-section">
        <legend>Medication Counseling</legend>
        <textarea name="med_counseling" class="med-counsel" rows="2" placeholder="복약 상담 내용을 입력하세요"></textarea>
      </fieldset>

      <!-- (6) IV Order -->
      <fieldset class="form-section">
        <legend>IV Order</legend>
        <div class="iv-order">
          <span class="iv-desc">
            N/S 500 ml + Vit B/C 2 mL ×4 amp (인당 15–20 mL)
          </span>
          <span class="iv-choice">
            <label><input type="radio" name="iv_order" value="O">O</label>
            <label><input type="radio" name="iv_order" value="X">X</label>
          </span>
        </div>
      </fieldset>

      <!-- (7) Signatures -->
      <div class="signature-block">
        <label>Dr. <input type="text" name="sign_dr" placeholder="서명"></label>
        <label>Nurse <input type="text" name="sign_nurse" placeholder="서명"></label>
        <label>Pharmacist <input type="text" name="sign_pharmacist" placeholder="서명"></label>
      </div>


      <!-- 저장/완료 버튼 -->
      <div class="button-group">
        <button type="submit" class="btn-submit">저장</button>
        <button type="button" class="btn-complete">진료 완료</button>
      </div>
    </form>
  </div>

  <!-- (3) 최근 진료 기록 -->
  <div class="emr-card recent-panel">
    <h2>최근 진료 기록</h2>
    {% if latest_record %}
    <div class="record">
      <p><strong>방문날짜:</strong> {{ latest_record.record_date.strftime('%Y-%m-%d') }}</p>
      <p><strong>주호소 (CC):</strong> {{ cc }}</p>
      <p><strong>병력 (PI):</strong> {{ pi }}</p>
    </div>
    {% else %}
    <p>진료 기록이 없습니다.</p>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/patient_emr.js"></script>
{% endblock %}